KISSY.add("wangpu/gallery/suggest",function(a,b,c,d){function e(c,d,f){var g,h=this;return h instanceof e?(h.textInput=b.get(c),h.config=f=a.merge($,f),"string"==typeof d?(d+=-1===d.indexOf("?")?"?":"&",h.dataSource=d+f.callbackName+"="+(g=f.callbackFn),2===f.dataType&&(h.config.dataType=0),g!==t&&i(g)):(h.dataSource=d,h.config.dataType=2),h.query=O,h.queryParams=O,h._dataCache={},h._init(),0):new e(c,d,f)}function f(a){a.style.visibility=O}function g(a){a.style.visibility=P}function h(a,c){1===c.nodeType?(b.html(a,O),a.appendChild(c)):b.html(a,c)}function i(b){var c,d=b.split("."),e=d.length;e>1?(b=b.replace(/^(.*)\..+$/,"$1"),c=a.namespace(b,!0),c[d[e-1]]=j):m[b]=j}function j(b){e.focusInstance&&a.later(function(){e.focusInstance._handleResponse(b)},0)}var k,l=a.UA,m=a.Env.host,n=c.Target,o=m.document,p=b.get("head"),q=l.ie,r=6===q,s=q>=9,t="KISSY.Suggest.callback",u="ks-suggest-",v=u+"style",w=u+"container",x=u+"key",y=u+"result",z="ks-selected",A="ks-odd",B="ks-even",C=u+"content",D=u+"footer",E=u+"closebtn",F=u+"shim",G="beforeStart",H="itemSelect",I="beforeSubmit",J="beforeDataRequest",K="dataReturn",L="updateFooter",M="beforeShow",N=200,O="",P="hidden",Q="display",R="none",S="LI",T="li",U="<div>",V="result",W="key",X="data-time",Y=parseInt,Z=/^(?:input|button|a)$/i,$={containerCls:O,resultFormat:"%result%",closeBtnText:"\u5173\u95ed",shim:r,submitOnSelect:!0,offset:-1,charset:"utf-8",callbackName:"callback",callbackFn:t,queryName:"q",dataType:0};return a.augment(e,n,{_init:function(){var a=this;k=o.body,a._initTextInput(),a._initContainer(),a.config.shim&&a._initShim(),a._initStyle(),a._initEvent()},_initTextInput:function(){var e=this,f=e.textInput,g=!1,h=0;b.attr(f,"autocomplete","off"),e.config.autoFocus&&f.focus(),c.on(f,"keydown",function(b){var c=b.keyCode;if((35==c||36==c)&&!f.value)return void b.halt();if(27===c)e.hide(),f.value=e.query;else if(c>32&&41>c)f.value?(40===c||38===c)&&(0===h++?(e._isRunning&&e.stop(),g=!0,e._selectItem(40===c)):3==h&&(h=0),b.preventDefault()):f.blur();else if(13===c){if(f.blur(),g&&f.value==e._getSelectedItemKey()&&e.fire(H)===!1)return;e._submitForm()}else e._isRunning||e.start(),g=!1;l.chrome&&(e._keyTimer&&e._keyTimer.cancel(),e._keyTimer=a.later(function(){e._keyTimer=d},500))}),c.on(f,"keyup",function(){h=0}),c.on(f,"blur",function(){e.stop(),a.later(function(){e._focusing||e.hide()},0)})},_initContainer:function(){var a=this,c=a.config.containerCls,d=b.create(U,{"class":w+(c?" "+c:O),style:"position:absolute;visibility:hidden"}),e=b.create(U,{"class":C}),f=b.create(U,{"class":D});d.appendChild(e),d.appendChild(f),k.insertBefore(d,k.firstChild),a.container=d,a.content=e,a.footer=f,a._initContainerEvent()},_setContainerRegion:function(){var a=this,c=a.config,d=a.textInput,e=b.offset(d),f=a.container;b.offset(f,{left:e.left,top:e.top+d.offsetHeight+c.offset}),b.width(f,c.containerWidth||d.offsetWidth-2)},_initContainerEvent:function(){var d,e,f=this,g=f.textInput,h=f.container,i=f.content,j=f.footer;c.on(i,"mousemove",function(a){if(!f._keyTimer){var c=a.target;c.nodeName!==S&&(c=b.parent(c,T)),b.contains(i,c)&&c!==f.selectedItem&&(f._removeSelectedItem(),f._setSelectedItem(c))}}),c.on(i,"mousedown",function(a){var c=a.target;c.nodeName!==S&&(c=b.parent(c,T)),d=c}),c.on(h,"mousedown",function(a){Z.test(a.target.nodeName)||(l.ie&&l.ie<9&&(g.onbeforedeactivate=function(){m.event.returnValue=!1,g.onbeforedeactivate=null}),a.preventDefault())}),c.on(i,"mouseup",function(a){var c=a.target;if(!(a.which>2)&&(c.nodeName!==S&&(c=b.parent(c,T)),c==d&&b.contains(i,c))){if(f._updateInputFromSelectItem(c),f.fire(H)===!1)return;try{g.blur()}catch(e){}f._submitForm()}}),c.on(j,"focusin",function(){f._focusing=!0,f._removeSelectedItem(),e=!1}),c.on(j,"focusout",function(){f._focusing=!1,a.later(function(){e?f.hide():f._focusing||f.textInput.focus()},0)}),c.on(f.container,"mouseleave",function(){e=!0}),c.on(j,"click",function(a){b.hasClass(a.target,E)&&f.hide()})},_submitForm:function(){var a=this;if(a.config.submitOnSelect){var b=a.textInput.form;if(!b)return;if(a.fire(I,{form:b})===!1)return;if(o.createEvent){var c=o.createEvent("MouseEvents");c.initEvent("submit",!0,!1),b.dispatchEvent(c)}else o.createEventObject&&b.fireEvent("onsubmit");b.submit()}},_initShim:function(){var a=b.create("<iframe>",{src:"about:blank","class":F,style:"position:absolute;visibility:hidden;border:none"});this.container.shim=a,k.insertBefore(a,k.firstChild)},_setShimRegion:function(){var a=this,c=a.container,d=c.style,e=c.shim;e&&b.css(e,{left:Y(d.left)-2,top:d.top,width:Y(d.width)+2,height:b.height(c)-2})},_initStyle:function(){var a=b.get("#"+v);a||b.addStyleSheet(".ks-suggest-container{background:white;border:1px solid #999;z-index:99999}.ks-suggest-shim{z-index:99998}.ks-suggest-container li{color:#404040;padding:1px 0 2px;font-size:12px;line-height:18px;float:left;width:100%}.ks-suggest-container .ks-selected{background-color:#39F;cursor:default}.ks-suggest-key{float:left;text-align:left;padding-left:5px}.ks-suggest-result{float:right;text-align:right;padding-right:5px;color:green}.ks-suggest-container .ks-selected span{color:#FFF;cursor:default}.ks-suggest-footer{padding:0 5px 5px}.ks-suggest-closebtn{float:right}.ks-suggest-container li,.ks-suggest-footer{overflow:hidden;zoom:1;clear:both}.ks-suggest-container{*margin-left:2px;_margin-left:-2px;_margin-top:-3px}",v)},_initEvent:function(){var a=this;c.on(m,"resize",function(){a._setContainerRegion(),a._setShimRegion()})},start:function(){var b=this;b.fire(G)!==!1&&(e.focusInstance=b,b._timer=a.later(function(){b._updateContent(),b._timer=a.later(arguments.callee,N)},N),b._isRunning=!0)},stop:function(){var a=this;e.focusInstance=d,a._timer&&a._timer.cancel(),a._isRunning=!1},show:function(){var a=this;if(!a.isVisible()){var b=a.container,c=b.shim;a._setContainerRegion(),f(b),c&&(a._setShimRegion(),f(c))}},hide:function(){if(this.isVisible()){var a=this.container,b=a.shim;b&&g(b),g(a)}},isVisible:function(){return this.container.style.visibility!=P},_updateContent:function(){var b,c=this,e=c.textInput;if(e.value!=c.query){if(b=c.query=e.value,!a.trim(b))return c._fillContainer(),void c.hide();switch(c.config.dataType){case 0:c._dataCache[b]!==d?(a.log("use cache"),c._fillContainer(c._dataCache[b]),c._displayContainer()):(a.log("no cache, data from server"),c._requestData());break;case 1:a.log("no cache, data always from server"),c._requestData();break;case 2:a.log("use static datasource"),c._handleResponse(c.dataSource[b])}}},_requestData:function(){var e,f=this,g=f.config;if((!q||s)&&(f.dataScript=d),!f.dataScript&&(e=o.createElement("script"),e.charset=g.charset,e.async=!0,p.insertBefore(e,p.firstChild),f.dataScript=e,!q||s)){var h=a.now();f._latestScriptTime=h,b.attr(e,X,h),c.on(e,"load",function(){f._scriptDataIsOut=b.attr(e,X)!=f._latestScriptTime})}f.queryParams=g.queryName+"="+encodeURIComponent(f.query),f.fire(J)!==!1&&(f.dataScript.src=f.dataSource+"&"+f.queryParams)},_handleResponse:function(a){var c=this,d=O;c._scriptDataIsOut||(c.returnedData=a,c.fire(K,{data:a})!==!1&&(d=c.config.contentRenderer?c.config.contentRenderer(a):c._renderContent(a),c._fillContainer(d),c.fire(M)!==!1&&(c.config.dataType||(c._dataCache[c.query]=b.html(c.content)),c._displayContainer())))},_renderContent:function(a){var c,d,e,f,g,h,i,j=this,k=O;if(c=j._formatData(j.returnedData),(e=c.length)>0){for(f=b.create("<ol>"),d=0;e>d;++d)i=c[d],g=j._formatItem(h=i[W],i[V]),b.attr(g,W,h),b.addClass(g,d%2?B:A),f.appendChild(g);k=f}return k},_formatData:function(b){var c,d,e,f=[],g=0;if(!b)return f;if(a.isArray(b[V])&&(b=b[V]),!(c=b.length))return f;for(e=0;c>e;++e)d=b[e],"string"==typeof d?f[g++]={key:d}:a.isArray(d)&&d.length>1&&(f[g++]={key:d[0],result:d[1]});return f},_formatItem:function(c,d){var e,f=b.create("<li>");return f.appendChild(b.create("<span>",{"class":x,html:c})),d&&(e=this.config.resultFormat.replace("%result%",d),a.trim(e)&&f.appendChild(b.create("<span>",{"class":y,html:e}))),f},_fillContainer:function(a,b){var c=this;c._fillContent(a||O),c._fillFooter(b||O),c.isVisible()&&c._setShimRegion()},_fillContent:function(a){h(this.content,a),this.selectedItem=d},_fillFooter:function(a){var c=this,d=c.config,e=c.footer;h(e,a),d.closeBtn&&e.appendChild(b.create("<a>",{"class":E,text:d.closeBtnText,href:"javascript: void(0)",target:"_self"})),c.fire(L,{footer:e,query:c.query}),b.css(e,Q,b.text(e)?O:R)},_displayContainer:function(){var c=this;a.trim(b.text(c.container))?c.show():c.hide()},_selectItem:function(c){var d,e=this,f=b.query(T,e.container);if(0!==f.length){if(!e.isVisible())return void e.show();e.selectedItem?(d=f[a.indexOf(e.selectedItem,f)+(c?1:-1)],d||(e.textInput.value=e.query)):d=f[c?0:f.length-1],e._removeSelectedItem(),d&&(e._setSelectedItem(d),e._updateInputFromSelectItem())}},_removeSelectedItem:function(){b.removeClass(this.selectedItem,z),this.selectedItem=d},_setSelectedItem:function(a){b.addClass(a,z),this.selectedItem=a,this.textInput.focus()},_getSelectedItemKey:function(){var a=this;return a.selectedItem?b.attr(a.selectedItem,W):O},_updateInputFromSelectItem:function(){var a=this;a.textInput.value=a._getSelectedItemKey(a.selectedItem)||a.query}}),e.version=1.1,e.callback=j,a.Suggest=e,e},{requires:["dom","event"]});KISSY.add("wangpu/gallery/template",function(a){function b(b){if(!c[b]){var d,e,f=a.guid(h),g=[n,f,o,e=t(b),p];try{d=new Function(f,g.join(""))}catch(i){g[3]=j+k+l+","+i.message+j+k,d=new Function(f,g.join(""))}c[b]={name:f,o:e,parser:g.join(""),render:d}}return c[b]}var c={},d={"#":"start","@":"start","/":"end"},e="KS_TEMPL_STAT_PARAM",f=new RegExp(e,"g"),g="KS_TEMPL",h="KS_DATA_",i="as",j='");',k=g+'.push("',l="KISSY.Template: Syntax Error. ",m="KISSY.Template: Render Error. ",n="var "+g+"=[],"+e+"=false;with(",o="||{}){try{"+g+'.push("',p='");}catch(e){'+g+'=["'+m+'" + e.message]}};return '+g+'.join("");',q=function(a){return a.replace(/\\"/g,'"')},r=function(a){return a.replace(/"/g,'\\"')},s=a.trim,t=function(b){var c,e;return r(s(b).replace(/[\r\t\n]/g," ").replace(/\\/g,"\\\\")).replace(/\{\{([#\/@]?)(?!\}\})([^}]*)\}\}/g,function(b,h,i){if(c="",i=q(s(i)),h){e=i.indexOf(" "),i=-1===e?[i,""]:[i.substring(0,e),i.substring(e)];var l,m=i[0],n=s(i[1]),o=u[m];o&&d[h]&&(l=o[d[h]],c=String(a.isFunction(l)?l.apply(this,n.split(/\s+/)):l.replace(f,n)))}else c=g+".push(typeof ("+i+') ==="undefined"?"":'+i+");";return j+c+k})},u={"if":{start:"if(typeof ("+e+') !=="undefined" && '+e+"){",end:"}"},"else":{start:"}else{"},elseif:{start:"}else if("+e+"){"},each:{start:function(a,b,c,d){var e="_ks_value",f="_ks_index";return b===i&&c&&(e=c||e,f=d||f),"KISSY.each("+a+", function("+e+", "+f+"){"},end:"});"},"!":{start:"/*"+e+"*/"}};return a.mix(b,{log:function(d){d in c?a.log(c[d].parser,"info"):(b(d),this.log(d))},addStatement:function(b,c){"string"==typeof b?u[b]=c:a.mix(u,b)}}),a.Template=b,b});